// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  password      String   // Added password field for authentication
  role          UserRole @default(VIEWER)
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  lastLoginAt   DateTime?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  organisations Organisation[] @relation("UserOrganisations")
  projects      Project[]      @relation("ProjectCreator")
  evidences     Evidence[]
  auditLogs     AuditLog[]
  // New workflow and compliance relations
  assignedWorkflows     Workflow[]
  assignedTasks         WorkflowTask[]
  assignedApprovals     WorkflowApproval[]
  assignedComplianceChecks ComplianceCheck[]

  // Performance indexes
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@index([lastLoginAt])
  @@index([role, isActive])
  @@map("users")
}

model Organisation {
  id          String   @id @default(cuid())
  name        String
  country     String?
  sector      String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users    User[]    @relation("UserOrganisations")
  projects Project[]

  // Performance indexes
  @@index([name])
  @@index([country])
  @@index([sector])
  @@index([createdAt])
  @@map("organisations")
}

model Project {
  id                   String            @id @default(cuid())
  organisationId       String
  name                 String
  scopeRaw             String?
  scopeStructuredJson  Json?
  boundariesJson       Json?
  createdBy            String
  status               ProjectStatus     @default(DRAFT)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  // Relations
  organisation        Organisation       @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  creator             User              @relation("ProjectCreator", fields: [createdBy], references: [id])
  materialityMaps     MaterialityMap[]
  reports             Report[]
  evidences           Evidence[]
  promptVersions      PromptVersion[]
  auditLogs           AuditLog[]
  // ESG Framework Relations
  tcfdAssessments      TCFDAssessment[]
  csrdAssessments      CSRDAassessment[]
  issbAssessments      ISSBAssessment[]
  sasbAssessments      SASBAssessment[]
  griAssessments       GRIAssessment[]
  dataPoints          ESGDataPoint[]
  workflows           Workflow[]
  complianceChecks    ComplianceCheck[]

  // Performance indexes
  @@index([organisationId])
  @@index([createdBy])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([organisationId, status])
  @@index([createdBy, status])
  @@map("projects")
}

model RegulatoryProfile {
  id            String   @id @default(cuid())
  jurisdiction  String
  standards     Json     // String array stored as JSON
  lastSyncedAt  DateTime?
  sourceRefs    Json     // String array stored as JSON
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("regulatory_profiles")
}

model MaterialityMap {
  id            String   @id @default(cuid())
  projectId     String
  topics        Json     // String array stored as JSON
  scores        Json     // Number array stored as JSON
  justification Json     // String array stored as JSON
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("materiality_maps")
}

model Report {
  id             String   @id @default(cuid())
  projectId      String
  version        Int
  contentJson    Json
  xbrlContent    String?  // XBRL tagged content
  pdfUrl         String?
  generatedAt    DateTime @default(now())
  generatorMeta  Json?

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("reports")
}

model Evidence {
  id          String   @id @default(cuid())
  projectId   String
  fileUrl     String
  uploadedBy  String
  clauseRefs  Json     // String array stored as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploadedBy], references: [id])

  @@map("evidences")
}

model AuditLog {
  id          String   @id @default(cuid())
  actor       String
  action      String
  detailJson  Json?
  timestamp   DateTime @default(now())

  // Relations
  user    User    @relation(fields: [actor], references: [id])
  project Project? @relation(fields: [projectId], references: [id])
  projectId String?

  // Performance indexes
  @@index([actor])
  @@index([action])
  @@index([timestamp])
  @@index([projectId])
  @@index([actor, timestamp])
  @@index([action, timestamp])
  @@map("audit_logs")
}

model PromptVersion {
  id             String   @id @default(cuid())
  projectId      String?
  promptText     String
  embeddingsMeta Json?
  createdAt      DateTime @default(now())

  // Relations
  project Project? @relation(fields: [projectId], references: [id])

  @@map("prompt_versions")
}

model RuleUpdate {
  id             String   @id @default(cuid())
  jurisdiction   String
  changeSummary  String
  sourceUrl      String?
  detectedAt     DateTime @default(now())

  @@map("rule_updates")
}

enum UserRole {
  ADMIN
  AUDITOR
  ANALYST
  VIEWER
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  REVIEW
  COMPLETED
  ARCHIVED
}

// TCFD (Task Force on Climate-related Financial Disclosures) Framework
model TCFDAssessment {
  id             String   @id @default(cuid())
  projectId      String
  governance     Json     // Governance structure and oversight
  strategy       Json     // Climate-related risks and opportunities
  riskManagement Json     // Risk management processes
  metricsTargets Json     // Metrics and targets used
  overallScore   Float?
  recommendations Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("tcfd_assessments")
}

// CSRD (Corporate Sustainability Reporting Directive) Framework
model CSRDAassessment {
  id                  String   @id @default(cuid())
  projectId           String
  doubleMateriality   Json     // Double materiality assessment results
  esrsReporting       Json     // ESRS (European Sustainability Reporting Standards) data
  sectorSpecific      Json     // Sector-specific requirements
  dueDiligence        Json     // Due diligence procedures
  datapoints          Json     // CSRD-specific data points
  overallCompliance   Float?
  gapAnalysis         Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("csrd_assessments")
}

// ISSB (International Sustainability Standards Board) Framework - Enhanced IFRS Standards
model ISSBAssessment {
  id              String   @id @default(cuid())
  projectId       String
  ifrsS1          Json     // IFRS S1: General Requirements for Sustainability-related Financial Disclosures
  ifrsS2          Json     // IFRS S2: Climate-related Disclosures
  ifrsS3          Json?    // IFRS S3: Nature-related Risks and Opportunities (proposed)
  ifrsS4          Json?    // IFRS S4: Human Rights and Social (proposed)
  ifrsS5          Json?    // IFRS S5: Human Resource Management (proposed)
  ifrsS6          Json?    // IFRS S6: Pollution and Resources (proposed)
  ifrsS7          Json?    // IFRS S7: Circular Economy (proposed)
  sustainability  Json     // General sustainability disclosures
  climate        Json     // Climate-specific disclosures
  nature         Json?     // Nature-related disclosures
  humanRights    Json?     // Human rights and social disclosures
  resources      Json?     // Pollution and resources disclosures
  circularEconomy Json?    // Circular economy disclosures
  overallScore   Float?
  recommendations Json?
  readiness       Json?    // IFRS implementation readiness assessment
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("issb_assessments")
}

// Enhanced SASB (Sustainability Accounting Standards Board) Framework
model SASBAssessment {
  id              String   @id @default(cuid())
  projectId       String
  industry        String   // SASB industry classification
  standards       Json     // Industry-specific SASB standards
  metrics         Json     // SASB metrics and calculations
  disclosures     Json     // SASB disclosure requirements
  benchmarkData   Json     // Industry benchmark data
  overallScore   Float?
  gapAnalysis     Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("sasb_assessments")
}

// GRI (Global Reporting Initiative) Standards Framework
model GRIAssessment {
  id                  String   @id @default(cuid())
  projectId           String
  universalStandards  Json     // GRI 1: Foundation, GRI 2: General Disclosures, GRI 3: Material Topics
  sectorStandards     Json     // GRI Sector Standards (if applicable)
  topicStandards      Json     // GRI Topic Standards (Economic, Environmental, Social)
  reportingPrinciples Json     // GRI reporting principles assessment
  stakeholderEngagement Json?  // Stakeholder engagement assessment
  materiality         Json     // Materiality assessment results
  disclosures         Json     // GRI-specific disclosure requirements
  overallScore        Float?
  gapAnalysis         Json?
  recommendations     Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("gri_assessments")
}

// Standardized ESG Data Points
model ESGDataPoint {
  id             String   @id @default(cuid())
  projectId      String
  category       String   // Environmental, Social, Governance
  subcategory    String   // e.g., Climate, Energy, Diversity, etc.
  metricName     String   // Standardized metric name
  metricCode     String   // Standard code (e.g., GRI_302_1, SASB_TC_AC_130a)
  value          Float?
  unit           String?
  year           Int?
  period         String?  // Annual, Quarterly, Monthly
  dataSource     String?
  confidence     Float?   // Data quality confidence score (0-1)
  validationStatus String @default("PENDING") // PENDING, VALIDATED, REJECTED, REVIEW
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([projectId])
  @@index([category])
  @@index([subcategory])
  @@index([metricCode])
  @@index([year])
  @@index([validationStatus])
  @@index([projectId, category])
  @@index([projectId, year])
  @@index([category, year])
  @@index([metricCode, year])
  @@map("esg_data_points")
}

// Compliance Workflow Management
model Workflow {
  id          String        @id @default(cuid())
  projectId   String
  name        String
  description String?
  type        WorkflowType @default(COMPLIANCE)
  status      WorkflowStatus @default(DRAFT)
  assigneeId  String?
  dueDate     DateTime?
  completedAt DateTime?
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  project    Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee   User?         @relation(fields: [assigneeId], references: [id])
  tasks      WorkflowTask[]
  approvals  WorkflowApproval[]

  @@map("workflows")
}

model WorkflowTask {
  id          String   @id @default(cuid())
  workflowId  String
  title       String
  description String?
  type        TaskType @default(MANUAL)
  status      TaskStatus @default(PENDING)
  assigneeId  String?
  dueDate     DateTime?
  completedAt DateTime?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  assignee User?    @relation(fields: [assigneeId], references: [id])

  @@map("workflow_tasks")
}

model WorkflowApproval {
  id          String        @id @default(cuid())
  workflowId  String
  level       Int
  title       String
  description String?
  status      ApprovalStatus @default(PENDING)
  assigneeId  String?
  approvedAt  DateTime?
  rejectedAt  DateTime?
  comments    String?
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  assignee User?    @relation(fields: [assigneeId], references: [id])

  @@map("workflow_approvals")
}

// Compliance Check Management
model ComplianceCheck {
  id             String   @id @default(cuid())
  projectId      String
  framework      String   // TCFD, CSRD, ISSB, SASB, GRI, etc.
  requirement    String   // Specific compliance requirement
  status         ComplianceStatus @default(PENDING)
  result         String?  // PASS, FAIL, PARTIAL, NOT_APPLICABLE
  evidence       String?  // Evidence reference
  gapDescription String?
  remediation    String?
  priority       Priority @default(MEDIUM)
  assigneeId     String?
  dueDate        DateTime?
  completedAt    DateTime?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee User?   @relation(fields: [assigneeId], references: [id])

  @@map("compliance_checks")
}

// Enums for new models
enum WorkflowType {
  COMPLIANCE
  DATA_COLLECTION
  REVIEW
  APPROVAL
  AUDIT
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  IN_REVIEW
  COMPLETED
  CANCELLED
}

enum TaskType {
  MANUAL
  AUTOMATED
  REVIEW
  APPROVAL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
}

enum ComplianceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  NOT_APPLICABLE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
enum StandardsVersionStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ValidationSeverity {
  ERROR
  WARNING
}

enum AssertionType {
  existenceAssertion
  valueAssertion
}

enum DimensionType {
  NONE
  EXPLICIT
  TYPED
}

enum StandardsIngestionStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

model StandardFramework {
  id          String   @id @default(cuid())
  code        String   @unique // GRI, ISSB, ESRS, etc.
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  versions      StandardVersion[]
  ingestionJobs StandardsIngestionJob[]

  @@map("standard_frameworks")
}

model StandardVersion {
  id              String                 @id @default(cuid())
  frameworkId     String
  versionTag      String
  sourceUrl       String
  effectiveFrom   DateTime?
  packageChecksum String
  notes           String?
  status          StandardsVersionStatus @default(DRAFT)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  framework       StandardFramework      @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  disclosures     StandardDisclosure[]
  datapoints      StandardDatapoint[]
  validationRules StandardValidationRule[]
  crosswalkFrom   StandardCrosswalk[]    @relation("crosswalkFrom")
  crosswalkTo     StandardCrosswalk[]    @relation("crosswalkTo")
  ingestionJobs   StandardsIngestionJob[]

  @@unique([frameworkId, versionTag])
  @@map("standard_versions")
}

model StandardDisclosure {
  id                String   @id @default(cuid())
  versionId         String
  disclosureId      String
  title             String
  level             Int
  mandatoryFor      String[]
  sectorSpecific    Boolean  @default(false)
  parentDisclosureId String?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  version StandardVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, disclosureId])
  @@map("standard_disclosures")
}

model StandardDatapoint {
  id            String        @id @default(cuid())
  versionId     String
  code          String
  label         String
  dataType      String
  unit          String?
  allowedValues String[]
  disclosureId  String?
  dimensionType DimensionType @default(NONE)
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  version StandardVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, code])
  @@map("standard_datapoints")
}

model StandardValidationRule {
  id            String             @id @default(cuid())
  versionId     String
  ruleCode      String
  severity      ValidationSeverity
  assertionType AssertionType
  expression    String
  disclosureId  String?
  metadata      Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  version StandardVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, ruleCode])
  @@map("standard_validation_rules")
}

model StandardCrosswalk {
  id               String   @id @default(cuid())
  fromVersionId    String
  toVersionId      String
  fromDisclosureId String
  toDisclosureId   String
  mappingType      String
  confidence       Float?
  rationale        String?
  createdAt        DateTime @default(now())

  fromVersion StandardVersion @relation("crosswalkFrom", fields: [fromVersionId], references: [id], onDelete: Cascade)
  toVersion   StandardVersion @relation("crosswalkTo", fields: [toVersionId], references: [id], onDelete: Cascade)

  @@map("standard_crosswalks")
}

model StandardsIngestionJob {
  id              String                   @id @default(cuid())
  frameworkId     String
  versionId       String
  createdBy       String
  status          StandardsIngestionStatus @default(PENDING)
  payloadChecksum String
  summaryJson     Json?
  errorJson       Json?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  framework StandardFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  version   StandardVersion   @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@map("standards_ingestion_jobs")
}
